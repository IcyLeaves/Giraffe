<html>
  <head>
    <link href="element.css" rel="stylesheet" type="text/css" />
  </head>

  <body>
    <div id="app">
      <div name="按钮组">
        <el-upload
          action="#"
          :auto-upload="false"
          :on-change="openFile"
          :show-file-list="false"
        >
          <el-button size="small" type="primary">点击上传</el-button>
        </el-upload>
        <el-button size="small" type="primary" @click="refreshCharts"
          >绘制一次</el-button
        >
        <el-button size="small" type="warning" @click="tabIndex =0"
          >图表视图</el-button
        >
        <el-button size="small" type="warning" @click="showJSON()"
          >JSON视图</el-button
        >
      </div>
      <div name="图表组">
        <div
          v-show="tabIndex===0"
          id="main"
          style="width: 600px; height: 400px"
        ></div>
        <div v-show="tabIndex===1">
          <el-input
            type="textarea"
            autosize
            placeholder="请输入内容"
            v-model="allDataStr"
            disabled
          >
          </el-input>
        </div>
      </div>

      <h2>节点信息</h2>
      <el-tabs v-model="activeTab">
        <el-tab-pane label="函数" name="func"
          ><el-form ref="nodeForm" :model="nodeInfo" label-width="80px">
            <el-form-item label="函数名称">
              <el-input
                v-model="nodeInfo.name"
                @input="bindInputFuncName"
              ></el-input>
            </el-form-item>
            <div id="editor" style="height: 600px; font-size: 20px">
              {{nodeInfo.extra?nodeInfo.extra.code:''}}
            </div>
          </el-form></el-tab-pane
        >
        <el-tab-pane label="节点" name="node"></el-tab-pane>
      </el-tabs>
    </div>
  </body>
  <script language="javascript" src="vue.js"></script>
  <script language="javascript" src="element.js"></script>
  <script language="javascript" src="echarts.js"></script>
  <script
    src="ace-builds/src-noconflict/ace.js"
    type="text/javascript"
    charset="utf-8"
  ></script>
  <script>
    var Default = new Vue({
      el: "#app",
      data: {
        tabIndex: 0,
        allDataStr: "{}",
        allData: {},
        nodeInfo: {},
        activeTab: "func",
      },
      watch: {
        allData: {
          handler: function (newValue, oldValue) {
            var myChart = echarts.init(document.getElementById("main"));
            myChart.setOption({
              series: [
                {
                  data: newValue.data,
                  links: newValue.links,
                },
              ],
            });
          },
          deep: true,
        },
      },
      methods: {
        // 根据FuncName查找data中的下标
        selectIdxByFuncName(name) {
          return this.allData.data.findIndex((x) => x.name === name);
        },
        //上传你的文件
        openFile(file) {
          var reader = new FileReader();
          reader.onload = () => {
            if (reader.result) {
              //打印文件内容
              this.allData = JSON.parse(reader.result);
              this.tabIndex = 0;
              this.refreshCharts();
            }
          };
          reader.readAsText(file.raw);
        },
        //显示JSON数据
        showJSON() {
          this.allDataStr = JSON.stringify(this.allData);
          this.tabIndex = 1;
        },
        //重新init一下图表
        refreshCharts() {
          var myChart = echarts.init(document.getElementById("main"));
          myChart.clear();
          myChart.resize();
          this.initCharts();
        },
        //初始化图表
        initCharts() {
          var that = this;
          // 基于准备好的dom，初始化echarts实例
          var myChart = echarts.init(document.getElementById("main"));
          // 指定图表的配置项和数据
          var option = {
            title: {
              text: "Basic Graph",
            },
            tooltip: {},
            series: [
              {
                id: "a",
                animation: false,
                type: "graph",
                layout: "none",
                symbol: "rect",
                draggable: false,
                edgeSymbol: ["", "arrow"],
                roam: true,
                label: {
                  show: true,
                },
                data: that.allData.data,
                links: that.allData.links,
              },
            ],
          };

          // 使用刚指定的配置项和数据显示图表。
          myChart.setOption(option);
          //配置可拖拽系统

          var updatePosition = () => {
            myChart.setOption({
              graphic: echarts.util.map(
                that.allData.data,
                function (item, dataIndex) {
                  var tmpPos = myChart.convertToPixel({ seriesIndex: 0 }, [
                    item.x,
                    item.y,
                  ]);
                  return {
                    x: tmpPos[0],
                    y: tmpPos[1],
                  };
                }
              ),
            });
          };
          var onPointDragging = function (dataIndex) {
            //节点上图层拖拽执行的函数
            var tmpPos = myChart.convertFromPixel(
              { seriesIndex: 0 },
              this.position
            );
            that.allData.data[dataIndex].x = tmpPos[0];
            that.allData.data[dataIndex].y = tmpPos[1];
            myChart.setOption(option);
            updatePosition();
          };
          myChart.setOption({
            graphic: echarts.util.map(
              that.allData.data,
              function (item, dataIndex) {
                //使用图形元素组件在节点上划出一个隐形的图形覆盖住节点
                var tmpPos = myChart.convertToPixel({ seriesIndex: 0 }, [
                  item.x,
                  item.y,
                ]);
                return {
                  id: dataIndex,
                  type: "rect",
                  info: dataIndex,
                  x: tmpPos[0],
                  y: tmpPos[1],
                  shape: {
                    x: -item.symbolSize[0] / 2,
                    y: -item.symbolSize[1] / 2,
                    width: item.symbolSize[0],
                    height: item.symbolSize[1],
                  },
                  // silent:true,
                  invisible: true,
                  draggable: true,
                  ondrag: echarts.util.curry(onPointDragging, dataIndex),
                  z: 100, //使图层在最高层
                };
              }
            ),
          });

          window.addEventListener("resize", updatePosition);
          myChart.on("dataZoom", updatePosition);
          myChart.on("graphRoam", updatePosition);
          //点击事件添加
          myChart.on("click", (params) => {
            if (params.dataType == "node") {
              that.onClickNodes(params.data);
            } else if (params.componentType == "graphic") {
              that.onClickNodes(that.allData.data[params.event.target.info]);
            } else that.onClickEdges(params);
          });
        },
        //节点点击事件
        onClickNodes(params) {
          this.nodeInfo = params;
        },
        onClickEdges(params) {},
        //输入函数名时要扩展节点的宽
        bindInputFuncName(e) {
          var idx = this.selectIdxByFuncName(e);
          this.nodeInfo.symbolSize[0] = 20 + e.length * 7;
          var myChart = echarts.init(document.getElementById("main"));
          myChart.setOption({
            graphic: [
              {
                id: idx,
                shape: {
                  x: -this.nodeInfo.symbolSize[0] / 2,
                  width: this.nodeInfo.symbolSize[0],
                },
              },
            ],
          });
        },
      },
      mounted: () => {
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/c_cpp");
      },
    });
  </script>
</html>
